<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Детали аниме</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Стили для страницы anime.html */
    body { margin: 0; padding: 0; background: #141414; color: #fff; font-family: sans-serif; }
    header { background: #000; padding: 1rem; text-align: center; color: #a749f8; }
    .container { max-width: 800px; margin: 0 auto; padding: 1rem; background: #1f1f1f; border-radius: 8px; }
    .anime-details { text-align: center; margin-bottom: 1.5rem; }
    .anime-details img { max-width: 100%; border-radius: 4px; margin-bottom: 1rem; }
    .episode-form { display: flex; flex-direction: column; gap: 0.7rem; margin-bottom: 1.5rem; background: #2a2a2a; padding: 1rem; border-radius: 8px; }
    .episode-form label { font-size: 0.9rem; color: #ccc; }
    .episode-form input { background: #1f1f1f; border: none; border-radius: 4px; padding: 0.5rem; color: #fff; }
    .episode-form input[type="submit"] { background: #a749f8; color: #fff; border: none; border-radius: 4px; padding: 0.7rem 1rem; cursor: pointer; }
    .episode-form input[type="submit"]:hover { background: #933ae0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.6rem; border-bottom: 1px solid #333; }
    th { background: #2a2a2a; text-align: left; }
    tr:hover td { background: #2a2a2a; }
  </style>
</head>
<body>
  <header>
    <h1>Детали аниме</h1>
  </header>
  <div class="container">
    <div class="anime-details" id="anime-details">
      <!-- Здесь выводятся обложка, название и описание аниме -->
    </div>
    <h2>Добавить эпизод</h2>
    <form id="episode-form" class="episode-form">
      <label for="episode-number">Номер эпизода</label>
      <input type="number" id="episode-number" required>
      <label for="episode-title">Название эпизода</label>
      <input type="text" id="episode-title" required>
      <label for="episode-player">Ссылка на плеер</label>
      <input type="url" id="episode-player" required>
      <input type="submit" value="Добавить эпизод">
    </form>
    <h2>Список эпизодов</h2>
    <table>
      <thead>
        <tr>
          <th>Номер</th>
          <th>Название</th>
          <th>Плеер</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="episode-table-body">
        <!-- Эпизоды будут добавляться здесь -->
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, getDocs, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrgoL47GPj30GHYkNBEBQyj3ddflFVXfI",
      authDomain: "anivision-194f5.firebaseapp.com",
      projectId: "anivision-194f5",
      storageBucket: "anivision-194f5.appspot.com",
      messagingSenderId: "793506779659",
      appId: "1:793506779659:web:b391b63343af935afbed0e",
      measurementId: "G-JGNDHJT219"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const db = getFirestore(appFirebase);

    // Извлекаем animeId из URL
    const urlParams = new URLSearchParams(window.location.search);
    const animeId = urlParams.get("animeId");
    if (!animeId) {
      alert("Не указан идентификатор аниме!");
    }

    async function loadAnimeDetails() {
      const animeDocRef = doc(db, "anime", animeId);
      try {
        const animeDoc = await getDoc(animeDocRef);
        if (animeDoc.exists()) {
          const data = animeDoc.data();
          const detailsDiv = document.getElementById("anime-details");
          detailsDiv.innerHTML = `
            <img src="${data.cover ? data.cover : 'https://via.placeholder.com/400x600?text=No+Image'}" alt="${data.title}">
            <h2>${data.title}</h2>
            <p>${data.desc ? data.desc : ""}</p>
          `;
        } else {
          alert("Аниме не найдено!");
        }
      } catch (error) {
        console.error("Ошибка при загрузке аниме:", error);
      }
    }

    loadAnimeDetails();

    const episodesCollection = collection(db, "anime", animeId, "episodes");

    async function loadEpisodes() {
      const tableBody = document.getElementById("episode-table-body");
      tableBody.innerHTML = "";
      try {
        const querySnapshot = await getDocs(episodesCollection);
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const docId = docSnap.id;
          renderEpisodeRow(docId, data);
        });
      } catch (error) {
        console.error("Ошибка при загрузке эпизодов:", error);
      }
    }

    function renderEpisodeRow(docId, data) {
      const tableBody = document.getElementById("episode-table-body");
      const tr = document.createElement("tr");

      const tdNumber = document.createElement("td");
      tdNumber.textContent = data.episodeNumber || "";
      tr.appendChild(tdNumber);

      const tdTitle = document.createElement("td");
      tdTitle.textContent = data.title || "";
      tr.appendChild(tdTitle);

      const tdPlayer = document.createElement("td");
      if (data.playerLink) {
        tdPlayer.innerHTML = `<a href="${data.playerLink}" target="_blank">Смотреть</a>`;
      } else {
        tdPlayer.textContent = "—";
      }
      tr.appendChild(tdPlayer);

      const tdActions = document.createElement("td");
      const btnDelete = document.createElement("button");
      btnDelete.textContent = "Удалить";
      btnDelete.addEventListener("click", async () => {
        if (confirm("Удалить этот эпизод?")) {
          try {
            await deleteDoc(doc(db, "anime", animeId, "episodes", docId));
            alert("Эпизод удалён!");
            loadEpisodes();
          } catch (error) {
            console.error("Ошибка при удалении эпизода:", error);
            alert("Ошибка при удалении эпизода!");
          }
        }
      });
      tdActions.appendChild(btnDelete);
      tr.appendChild(tdActions);

      tableBody.appendChild(tr);
    }

    document.getElementById("episode-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const episodeNumber = document.getElementById("episode-number").value;
      const episodeTitle = document.getElementById("episode-title").value.trim();
      const episodePlayer = document.getElementById("episode-player").value.trim();

      if (!episodeNumber || !episodeTitle || !episodePlayer) {
        alert("Заполните все поля!");
        return;
      }

      try {
        await addDoc(episodesCollection, {
          episodeNumber: parseInt(episodeNumber),
          title: episodeTitle,
          playerLink: episodePlayer
        });
        alert("Эпизод успешно добавлен!");
        document.getElementById("episode-form").reset();
        loadEpisodes();
      } catch (error) {
        console.error("Ошибка при добавлении эпизода:", error);
        alert("Ошибка при добавлении эпизода.");
      }
    });

    loadEpisodes();
  </script>
</body>
</html>
